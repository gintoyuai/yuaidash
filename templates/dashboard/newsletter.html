{% extends "dashboard/mainbase.html" %}
{% load static %}

{% block content %}
<style>
    .newsletter-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .stat-card {
        background: #fff;
        border-radius: 12px;
        padding: 25px;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: #4a6cf7;
        margin-bottom: 10px;
    }
    .stat-label {
        color: #666;
        font-size: 14px;
    }
    
    .newsletter-section {
        background: #fff;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .section-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
    }
    .section-title {
        font-size: 1.5rem;
        color: #333;
        margin: 0;
    }
    
    .subscriber-list, .campaign-list {
        max-height: 400px;
        overflow-y: auto;
    }
    .subscriber-item, .campaign-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        border-bottom: 1px solid #f0f0f0;
    }
    .subscriber-item:last-child, .campaign-item:last-child {
        border-bottom: none;
    }
    .subscriber-info h4, .campaign-info h4 {
        margin: 0 0 5px 0;
        color: #333;
    }
    .subscriber-info p, .campaign-info p {
        margin: 0;
        color: #666;
        font-size: 14px;
    }
    .subscriber-actions, .campaign-actions {
        display: flex;
        gap: 10px;
    }
    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
    }
    .status-active {
        background: #d4edda;
        color: #155724;
    }
    .status-inactive {
        background: #f8d7da;
        color: #721c24;
    }
    .status-sent {
        background: #d1ecf1;
        color: #0c5460;
    }
    .status-draft {
        background: #fff3cd;
        color: #856404;
    }
    
    .btn {
        padding: 8px 16px;
        border-radius: 6px;
        text-decoration: none;
        font-size: 14px;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }
    .btn-primary {
        background: #4a6cf7;
        color: white;
    }
    .btn-success {
        background: #28a745;
        color: white;
    }
    .btn-warning {
        background: #ffc107;
        color: #212529;
    }
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    .btn-sm {
        padding: 5px 10px;
        font-size: 12px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
    }
    .form-control {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 15px;
    }
    textarea.form-control {
        min-height: 150px;
        resize: vertical;
    }
    
    .add-subscriber-form {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }
    .add-subscriber-form input {
        flex: 1;
    }
</style>

<div class="main-content">
    <div class="header">
        <div class="header-left">
            <div class="menu-toggle" id="menu-toggle">
                <i class="fas fa-bars"></i>
            </div>
            
        </div>

        <div class="header-right">
            <div class="header-action">
                <i class="far fa-bell"></i>
                <span class="notification-badge">3</span>
            </div>
            <div class="header-action">
                <i class="far fa-envelope"></i>
                <span class="notification-badge">5</span>
            </div>
            <div class="user-profile">
                <div class="user-avatar">A</div>
                <div class="user-info">
                    <div class="user-name">Admin User</div>
                    <div class="user-role">Administrator</div>
                </div>
            </div>
        </div>
    </div>

    <div class="content">
        <div class="content-header">
            <h1>Newsletter Management</h1>
            <div class="breadcrumb">
                <a href="#">Home</a> <i class="fas fa-chevron-right" style="font-size: 10px;"></i>
                <span>Newsletter</span>
            </div>
        </div>

        {% if messages  %}
        <div class="messages">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Statistics Cards -->
        <div class="newsletter-stats">
            <div class="stat-card">
                <div class="stat-number">{{ total_count }}</div>
                <div class="stat-label">Total Subscribers</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ active_count }}</div>
                <div class="stat-label">Active Subscribers</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ inactive_count }}</div>
                <div class="stat-label">Inactive Subscribers</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ campaigns|length }}</div>
                <div class="stat-label">Campaigns Sent</div>
            </div>
        </div>

        <!-- Add Subscriber Section -->
        <div class="newsletter-section">
            <div class="section-header">
                <h2 class="section-title">Add New Subscriber</h2>
            </div>
            <form method="POST" action="{% url 'add_subscriber' %}" class="add-subscriber-form">
                {% csrf_token %}
                <input type="email" name="email" class="form-control" placeholder="Enter email address" required>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Subscriber
                </button>
            </form>
        </div>

        <!-- Subscribers List -->
        <div class="newsletter-section">
            <div class="section-header">
                <h2 class="section-title">Subscribers ({{ total_count }})</h2>
                <a href="{% url 'export_subscribers' %}" class="btn btn-secondary">
                    <i class="fas fa-download"></i> Export CSV
                </a>
            </div>
            <div class="subscriber-list">
                {% for subscriber in newsletter_obj %}
                <div class="subscriber-item">
                    <div class="subscriber-info">
                        <h4>{{ subscriber.email }}</h4>
                        <p>Subscribed: {{ subscriber.subscribed_at|date:"M d, Y H:i" }}</p>
                    </div>
                    <div class="subscriber-actions">
                        <span class="status-badge {% if subscriber.status == 'active' %}status-active{% else %}status-inactive{% endif %}">
                            {% if subscriber.status == 'active' %}Active{% else %}Inactive{% endif %}
                        </span>
                        <form method="POST" action="{% url 'toggle_subscriber' subscriber.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm {% if subscriber.is_active %}btn-warning{% else %}btn-success{% endif %}">
                                {% if subscriber.is_active %}<i class="fas fa-pause"></i>{% else %}<i class="fas fa-play"></i>{% endif %}
                            </button>
                        </form>
                        <form method="POST" action="{% url 'delete_subscriber' subscriber.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this subscriber?')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </div>
                </div>
                {% empty %}
                <p style="text-align: center; color: #666; padding: 20px;">No subscribers found.</p>
                {% endfor %}

                <!-- Pagination -->
        <div class="pagination">
            {% if newsletter_obj.has_previous %}
            <a href="?page={{ newsletter_obj.previous_page_number }}" class="page-link">&laquo;</a>
            {% else %}
            <span class="page-link">&laquo;</span>
            {% endif %}

            {% for num in newsletter_obj.paginator.page_range %}
            {% if num == newsletter_obj.number %}
            <span class="current-page">{{ num }}</span>
            {% elif num > newsletter_obj.number|add:'-3' and num < newsletter_obj.number|add:'3' %}
            <a href="?page={{ num }}" class="page-link">{{ num }}</a>
            {% endif %}
            {% endfor %}

            {% if newsletter_obj.has_next %}
            <a href="?page={{ newsletter_obj.next_page_number }}" class="page-link">&raquo;</a>
            {% else %}
            <span class="page-link">&raquo;</span>
            {% endif %}
        </div>

            </div>
        </div>

        <!-- Create Campaign Section -->
        <div class="newsletter-section">
            <div class="section-header">
                <h2 class="section-title">Create New Campaign</h2>
            </div>
            <form method="POST" action="{% url 'create_campaign' %}">
                {% csrf_token %}

                <div class="form-group">
                    <label for="name">Name of Campaign</label>
                    <input type="text" id="name" name="name" class="form-control" placeholder="Enter Name of Campaign" required>
                </div>

                <div class="form-group">
                    <label for="subject">Subject</label>
                    <input type="text" id="subject" name="subject" class="form-control" placeholder="Enter email subject" required>
                </div>
                <div class="form-group">
                    <label for="content">Content</label>
                    <textarea id="content" name="content" class="form-control" placeholder="Enter your newsletter content..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Campaign
                </button>
            </form>
        </div>

        <!-- Campaigns List -->
        <div class="newsletter-section">
            <div class="section-header">
                <h2 class="section-title">Campaigns ({{ campaigns.count }})</h2>
            </div>
            <div class="campaign-list">
                {% for campaign in campaigns %}
                <div class="campaign-item">
                    <div class="campaign-info">
                        <h4>{{ campaign.subject }}</h4>
                        <p>Created: {{ campaign.created_at|date:"M d, Y H:i" }}</p>
                        <p>{{ campaign.message|truncatewords:20 }}</p>
                    </div>
                    <div class="campaign-actions">
                      <span class="status-badge 
                            {% if campaign.status == 'sent' %}
                                status-sent
                            {% elif campaign.status == 'scheduled' %}
                                status-scheduled
                            {% elif campaign.status == 'cancelled' %}
                                status-cancelled
                            {% else %}
                                status-draft
                            {% endif %}
                        ">
                            {{ campaign.status|capfirst }}
                        </span>

                        {% if not campaign.is_sent %}
                        <form method="POST" action="{% url 'send_campaign' campaign.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('Send this campaign to all active subscribers?')">
                                <i class="fas fa-paper-plane"></i> Send
                            </button>
                        </form>
                        {% endif %}
                        <form method="POST" action="{% url 'delete_campaign' campaign.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this campaign?')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </div>
                </div>
                {% empty %}
                <p style="text-align: center; color: #666; padding: 20px;">No campaigns found.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    document.querySelector('.search-box input').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();

        document.querySelectorAll('.subscriber-item').forEach(item => {
            const email = item.querySelector('h4').textContent.toLowerCase();
            item.style.display = email.includes(searchTerm) ? 'flex' : 'none';
        });
     
        document.querySelectorAll('.campaign-item').forEach(item => {
            const subject = item.querySelector('h4').textContent.toLowerCase();
            item.style.display = subject.includes(searchTerm) ? 'flex' : 'none';
        });
    });
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Toggle Subscriber Status
    document.querySelectorAll('.toggle-btn').forEach(button => {
        button.addEventListener('click', function() {
            const subscriberId = this.getAttribute('data-id');
            const currentStatus = this.getAttribute('data-current-status');
            const email = this.closest('.subscriber-item').getAttribute('data-email');
            
            if (confirm(`Are you sure you want to ${currentStatus === 'active' ? 'deactivate' : 'activate'} ${email}?`)) {
                toggleSubscriberStatus(subscriberId, this);
            }
        });
    });

    // Delete Subscriber
    document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', function() {
            const subscriberId = this.getAttribute('data-id');
            const email = this.getAttribute('data-email');
            
            if (confirm(`Are you sure you want to permanently delete ${email}? This action cannot be undone.`)) {
                deleteSubscriber(subscriberId, this);
            }
        });
    });

    function toggleSubscriberStatus(subscriberId, button) {
        const originalText = button.innerHTML;
        button.innerHTML = '<span class="spinner"></span> Updating...';
        button.disabled = true;

        fetch(`/toggle-subscriber/${subscriberId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Update button appearance
                const isNowActive = data.new_status === 'active';
                
                // Update status badge
                const statusBadge = document.getElementById(`status-${subscriberId}`);
                statusBadge.textContent = data.new_status.charAt(0).toUpperCase() + data.new_status.slice(1);
                statusBadge.className = `status-badge ${isNowActive ? 'status-active' : 'status-inactive'}`;
                
                // Update button
                button.setAttribute('data-current-status', data.new_status);
                button.className = `btn btn-sm ${isNowActive ? 'btn-warning' : 'btn-success'} toggle-btn`;
                button.innerHTML = isNowActive ? 
                    '<i class="fas fa-pause"></i> Deactivate' : 
                    '<i class="fas fa-play"></i> Activate';
                
                showMessage(data.message, 'success');
            } else {
                showMessage(data.message, 'error');
                button.innerHTML = originalText;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('An error occurred while updating subscriber', 'error');
            button.innerHTML = originalText;
        })
        .finally(() => {
            button.disabled = false;
        });
    }

    function deleteSubscriber(subscriberId, button) {
        const subscriberItem = button.closest('.subscriber-item');
        const originalText = button.innerHTML;
        
        button.innerHTML = '<span class="spinner"></span> Deleting...';
        button.disabled = true;

        fetch(`/delete-subscriber/${subscriberId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Remove the subscriber item with animation
                subscriberItem.style.opacity = '0';
                subscriberItem.style.transform = 'translateX(-100%)';
                setTimeout(() => {
                    subscriberItem.remove();
                    
                    // Check if list is empty now
                    const subscriberList = document.getElementById('subscribersList');
                    if (subscriberList.children.length === 0 || 
                        (subscriberList.children.length === 1 && subscriberList.children[0].classList.contains('empty-state'))) {
                        subscriberList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-users"></i>
                                <h3>No Subscribers Found</h3>
                                <p>Add your first subscriber using the form above.</p>
                            </div>
                        `;
                    }
                }, 300);
                
                showMessage(data.message, 'success');
            } else {
                showMessage(data.message, 'error');
                button.innerHTML = originalText;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('An error occurred while deleting subscriber', 'error');
            button.innerHTML = originalText;
        })
        .finally(() => {
            button.disabled = false;
        });
    }

    function showMessage(message, type) {
        // Create message element
        const messageDiv = document.createElement('div');
        messageDiv.className = `alert alert-${type}`;
        messageDiv.innerHTML = `
            ${message}
            <button type="button" class="close-alert" onclick="this.parentElement.remove()" style="float: right; background: none; border: none; font-size: 16px; cursor: pointer;">Ã—</button>
        `;
        
        // Add to messages container
        const messagesContainer = document.querySelector('.messages') || createMessagesContainer();
        messagesContainer.appendChild(messageDiv);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (messageDiv.parentElement) {
                messageDiv.remove();
            }
        }, 5000);
    }

    function createMessagesContainer() {
        const container = document.createElement('div');
        container.className = 'messages';
        document.querySelector('.content').insertBefore(container, document.querySelector('.content').firstChild);
        return container;
    }
});
</script>

{% endblock %}