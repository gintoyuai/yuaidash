{% extends "dashboard/mainbase.html" %}
{% load static %}

{% block content %}

<!-- MAIN CONTENT -->
<div class="main-content">
    <!-- HEADER -->
    <div class="header">
        <div class="header-left">
            <div class="menu-toggle" id="menu-toggle">
                <i class="fas fa-bars"></i>
            </div>
           
        </div>

        <div class="header-right">
            <div class="header-action">
                <i class="far fa-bell"></i>
                <span class="notification-badge">3</span>
            </div>
            <div class="header-action">
                <i class="far fa-envelope"></i>
                <span class="notification-badge">5</span>
            </div>
            <div class="user-profile">
                <div class="user-avatar">A</div>
                <div class="user-info">
                    <div class="user-name">Admin User</div>
                    <div class="user-role">Administrator</div>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTENT AREA -->
    <div class="content">
        <div class="content-header">
            <h1>User Queries</h1>
            <div class="breadcrumb">
                <a href="#">Home</a> <i class="fas fa-chevron-right" style="font-size: 10px;"></i>
                <span>Queries</span>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-envelope"></i>
                </div>
                <div class="stat-number">{{ total_queries|default:0 }}</div>
                <div class="stat-label">Total Queries</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-plus-circle"></i>
                </div>
                <div class="stat-number">{{ pending_queries|default:0 }}</div>
                <div class="stat-label">Pending Queries</div>
            </div>


            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-number">{{ resolved_queries|default:0 }}</div>
                <div class="stat-label">Resolved Queries</div>
            </div>
        </div>

        <!-- Queries Header -->
        <div class="queries-header">
            <h2>Customer Enquiries</h2>
            <div>
                <a href="{% url 'export_queries_csv' %}" class="btn-primary">
                    <i class="fas fa-download"></i> Export CSV
                </a>
            </div>
        </div>

        <!-- Filters -->
        <div class="query-filters">
            <form method="GET" action="{% url 'queries' %}" id="filterForm" class="query-filters" style="display: flex; gap: 15px; align-items: flex-end;">
                <div class="filter-group" style="display: flex; flex-direction: column;">
                    <label for="status-filter">Status</label>
                    <select name="status" id="status-filter" onchange="document.getElementById('filterForm').submit()">
                        <option value="">All Status</option>
                        <option value="pending_queries" {% if request.GET.status == 'pending_queries' %}selected{% endif %}>Pending Queries</option>
                        <option value="resolved_queries" {% if request.GET.status == 'resolved_queries' %}selected{% endif %}>Resolved Queries</option>
                    </select>
                </div>

                <div class="filter-group" style="display: flex; flex-direction: column;">
                    <label for="date-filter">Date</label>
                    <select name="date" id="date-filter" onchange="document.getElementById('filterForm').submit()">
                        <option value="">All Dates</option>
                        <option value="today" {% if request.GET.date == 'today' %}selected{% endif %}>Today</option>
                        <option value="week" {% if request.GET.date == 'week' %}selected{% endif %}>This Week</option>
                        <option value="month" {% if request.GET.date == 'month' %}selected{% endif %}>This Month</option>
                    </select>
                </div>

                <div class="filter-group" style="display: flex; flex-direction: column;">
                    <label for="search">Search</label>
                    <input type="text" name="search" id="search" placeholder="Search queries..." value="{{ request.GET.search }}">
                </div>

            </form>
        </div>

            
    

        <!-- Queries List -->
        <div class="queries-list" style="margin:20px;">
            
            {% for query in queries_obj %}
            <div class="query-item" onclick="openQueryModal('{{ query.id }}', '{{ query.name|escapejs }}', '{{ query.email }}', '{{ query.phone|default:""|escapejs }}', '{{ query.subject|escapejs }}', `{{ query.message|escapejs }}`, '{{ query.status }}')" style="margin:20px;">
                <div class="query-subject">
                    <span>{{ query.subject }}</span>
                    <span class="query-status status-{{ query.status|lower }}">{{ query.status }}</span>
                </div>
                <div class="query-meta">
                    <div class="meta-item">
                        <i class="fas fa-user"></i> {{query.name}}
                    </div>

                    <div class="meta-item">
                        <i class="fas fa-clock"></i> {{query.date}}
                    </div>

                    <div class="meta-item">
                        <i class="fas fa-envelope"></i> {{query.email}}
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-phone"></i> {{query.phone}}
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-calendar"></i> {{query.status}}
                    </div>
                </div>
                <div class="query-preview">
                    {{query.message|truncatechars:100}}
                </div>
                <div class="query-actions">
                    <a href="#" class="query-action-btn btn-view" 
                       onclick="event.stopPropagation(); openQueryModal('{{ query.id }}', '{{ query.name|escapejs }}', '{{ query.email }}', '{{ query.phone|default:""|escapejs }}', '{{ query.subject|escapejs }}', `{{ query.message|escapejs }}`, '{{ query.status }}')">
                        <i class="fas fa-eye"></i> View Details
                    </a>
                    
                    {% if query.status == 'resolved' %}
                        <span class="query-action-btn btn-disabled">
                            <i class="fas fa-check-circle"></i> Responded
                        </span>
                    {% else %}
                        <a href="#" class="query-action-btn" 
                           onclick="event.stopPropagation(); openResponseModal('{{ query.id }}', '{{ query.email }}', '{{ query.subject|escapejs }}')">
                            <i class="fas fa-reply"></i> Respond
                        </a>
                    {% endif %}
                    
                    {% if query.status == 'pending' %}
                        <a href="{% url 'mark_query_resolved' query.id %}" 
                           class="query-action-btn" 
                           onclick="event.stopPropagation(); return confirm('Mark this query as resolved?')">
                            <i class="fas fa-check"></i> Mark as Resolved
                        </a>
                    {% else %}
                        <span class="query-action-btn btn-disabled">
                            <i class="fas fa-check-circle"></i> Resolved
                        </span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>


        <div class="pagination">
            {% for num in queries_obj.paginator.page_range %}
                {% if queries_obj.number == num %}
                    <span class="current-page">{{ num }}</span>
                {% else %}
                    <a href="?page={{ num }}" class="page-link">{{ num }}</a>
                {% endif %}
            {% endfor %}
            
            {% if queries_obj.has_next %}
                <a href="?page={{ queries_obj.next_page_number }}" class="page-link">&raquo;</a>
            {% endif %}
       </div>
    </div>
</div>


<!-- Query Detail Modal -->
<div class="modal" id="queryModal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeQueryModal()">&times;</span>
        <div class="modal-header">
            <h2>Query Details</h2>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- Content will be dynamically inserted here -->
        </div>
    </div>
</div>

<!-- Response Modal -->
<div class="modal" id="responseModal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeResponseModal()">&times;</span>
        <div class="modal-header">
            <h2>Send Response</h2>
        </div>
        <div class="modal-body">
            <div class="response-info">
                <p><strong>Subject:</strong> <span id="responseQuerySubject"></span></p>
                <p><strong>Recipient:</strong> <span id="responseQueryEmail"></span></p>
            </div>
            
            <form method="POST" action="{% url 'send_query_response' %}" id="responseForm">
                {% csrf_token %}
                <input type="hidden" name="query_id" id="responseQueryId">
                
                <div class="form-group">
                    <label for="responseText">Your Response:</label>
                    <textarea 
                        name="response_text" 
                        id="responseText" 
                        rows="8" 
                        class="form-control" 
                        placeholder="Type your response here..."
                        required
                    ></textarea>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeResponseModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-paper-plane"></i> Send Response
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.query-detail-section {
    margin-bottom: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 5px;
}

.query-detail-section h3 {
    margin-bottom: 10px;
    color: #333;
    font-size: 16px;
    font-weight: 600;
}

.query-detail-section p {
    margin: 8px 0;
    color: #555;
    line-height: 1.6;
}

.btn-disabled {
    opacity: 0.6;
    cursor: not-allowed;
    pointer-events: none;
    background: #e0e0e0 !important;
}

.response-info {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
}

.response-info p {
    margin: 8px 0;
    color: #555;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
}

.form-control {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-family: inherit;
    font-size: 14px;
    resize: vertical;
}

.form-control:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}

.btn-secondary {
    padding: 10px 20px;
    background: #6c757d;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.3s;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-primary {
    padding: 10px 20px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.3s;
}

.btn-primary:hover {
    background: #0056b3;
}
</style>

<script>
    // Toggle sidebar on mobile
    document.getElementById('menu-toggle').addEventListener('click', function () {
        document.getElementById('sidebar').classList.toggle('active');
    });

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function (event) {
        const sidebar = document.getElementById('sidebar');
        const menuToggle = document.getElementById('menu-toggle');
        const isMobile = window.innerWidth <= 992;

        if (isMobile && sidebar.classList.contains('active') &&
            !sidebar.contains(event.target) &&
            !menuToggle.contains(event.target)) {
            sidebar.classList.remove('active');
        }
    });

    // Modal functionality
    function openQueryModal(queryId, queryName, queryEmail, queryPhone, querySubject, queryMessage, queryStatus) {
        const modal = document.getElementById('queryModal');
        const modalBody = document.getElementById('modalBody');
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Populate modal with query details
        modalBody.innerHTML = `
            <div class="query-detail-section">
                <h3><i class="fas fa-user"></i> Contact Information</h3>
                <p><strong>Name:</strong> ${escapeHtml(queryName)}</p>
                <p><strong>Email:</strong> ${escapeHtml(queryEmail)}</p>
                <p><strong>Phone:</strong> ${queryPhone ? escapeHtml(queryPhone) : 'Not provided'}</p>
                <p><strong>Status:</strong> <span class="query-status status-${queryStatus.toLowerCase()}">${escapeHtml(queryStatus)}</span></p>
            </div>
            
            <div class="query-detail-section">
                <h3><i class="fas fa-envelope"></i> Subject</h3>
                <p>${escapeHtml(querySubject)}</p>
            </div>
            
            <div class="query-detail-section">
                <h3><i class="fas fa-comment"></i> Message</h3>
                <p style="white-space: pre-wrap;">${escapeHtml(queryMessage)}</p>
            </div>
        `;
        
        modal.style.display = "flex";
    }

    function openResponseModal(queryId, queryEmail, querySubject) {
        const modal = document.getElementById('responseModal');
        
        // Set form values
        document.getElementById('responseQueryId').value = queryId;
        document.getElementById('responseQueryEmail').textContent = queryEmail;
        document.getElementById('responseQuerySubject').textContent = querySubject;
        document.getElementById('responseText').value = '';
        
        modal.style.display = "flex";
    }

    function closeQueryModal() {
        document.getElementById('queryModal').style.display = "none";
    }

    function closeResponseModal() {
        document.getElementById('responseModal').style.display = "none";
    }

    // Close modals when clicking outside
    window.addEventListener('click', function(event) {
        const queryModal = document.getElementById('queryModal');
        const responseModal = document.getElementById('responseModal');
        
        if (event.target === queryModal) {
            closeQueryModal();
        }
        if (event.target === responseModal) {
            closeResponseModal();
        }
    });
</script>

{% endblock %}